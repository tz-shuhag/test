/*! (c) FunnyMonkey under Copyright Reserved */
(e=>{"use strict";e.ConnectHelper=function(t){this.init=async()=>{const a={langvars:t.helper.language.getLangVars,openLink:t.helper.util.openLink},n=e=>{e._timer&&(clearTimeout(e._timer),delete e._timer)},i=e=>{n(e),e.disconnect()},s=(e,t)=>{try{t.postMessage({uid:e.uid,result:"Yes, I am here"})}catch(e){}};e.api.runtime.onConnect.addListener((e=>{e.name&&"keepalive"!==e.name||(e.onMessage.addListener(s),e.onDisconnect.addListener(n),e._timer=setTimeout(i,25e3,e))})),e.api.runtime.onMessage.addListener(((e,n,i)=>{if(a[e.type])e.tabId=n.tab?n.tab.id:null,a[e.type](e).then((e=>{i(e)})).catch((e=>{t.log(e),i()}));else{if("theme"===e.type);else t.log("Unknown message type:"+e.type);i()}return!0}))}},e.DaoHelper=function(t){let a={};this.init=()=>new Promise((t=>{e.api.storage.local.get(["model"],(e=>{a=e.model||{},void 0===a.installationDate&&(a.installationDate=+new Date),void 0===a.lastUpdateDate&&(a.lastUpdateDate=+new Date),n().then(t)}))})),this.setData=(e,t)=>new Promise((i=>{a[e]=t,n().then(i)})),this.setValue=e=>new Promise((t=>{a[e.key]=e.value,n().then(t)})),this.getValue=e=>new Promise((t=>{t(this.getData(e.key))})),this.getData=e=>a[e]||null;const n=()=>new Promise((t=>{Object.getOwnPropertyNames(a).length>0&&e.api.storage.sync.set({model:a},(()=>{e.api.runtime.lastError,t()}))}))},e.LanguageHelper=function(t){const a={en:"English",es:"Español",ar:"العربية",fr:"Français",pt:"Português",ru:"Русский",ja:"日本語",de:"Deutsch",ko:"한국어",it:"Italiano",id:"Bahasa Indonesia",tr:"Türkçe",pl:"Polski",uk:"Українська",nl:"Nederlands",vi:"Tiếng Việt",ms:"Bahasa Melayu",th:"ไทย",zh_CN:"Chinese (Simplified)",zh_TW:"Chinese (Traditional)"},n=["ar","fa","he"],i={pt:"pt_PT"};let s=null,l={},o=!1;this.init=()=>new Promise((t=>{(e.api.storage.sync||e.api.storage.local).get(["language"],(a=>{const p=e.opts.manifest.default_locale;let h="default";a&&a.language&&(h=a.language);let u=null;if("default"===h){const e=this.getUILanguage();e&&(h=e)}h=h.replace("-","_"),i[h]&&(h=i[h]),h.indexOf("_")>-1&&(u=h.replace(/_.*$/,"")),this.getAvailableLanguages().then((e=>{[h,u,p].some((a=>{if(null!==a&&e&&e.infos&&e.infos[a]&&e.infos[a].available)return s=a,o=n.indexOf(s)>-1,r(a,p).then((e=>{e&&e.langVars&&(l=e.langVars,t())})),!0}))}))}))})),this.getUILanguage=()=>{try{let t=e.api.i18n.getUILanguage();return t=t.replace("-","_"),t}catch(e){}return null},this.getLanguage=()=>s,this.getRtlLanguages=async()=>n,this.getLangVars=()=>new Promise((e=>{e({language:s,dir:o?"rtl":"ltr",vars:l})})),this.getAvailableLanguages=()=>new Promise((t=>{const n=Object.keys(a).length;let i=0;const s={};Object.keys(a).forEach((l=>{s[l]={name:l,label:a[l],available:!1};const o=()=>{++i===n&&t({infos:s})};e.fetch(e.api.runtime.getURL("_locales/"+l+"/messages.json"),{method:"HEAD"}).then((()=>{s[l].available=!0,o()}),o).catch((e=>{}))}))})),this.getIncompleteLanguages=()=>new Promise((t=>{e.xhr(e.opts.website.translation.info).then((e=>{const a=JSON.parse(e.responseText),n=[];if(a&&a.languages&&a.categories){let e=0;Object.values(a.categories).forEach((t=>{e+=t.total})),a.languages.forEach((t=>{t.varsAmount<e&&n.push(t.name)}))}t(n)}))}));const r=(t,a=null)=>new Promise((n=>{if(t){const i=a=>{const i=a.langVars;e.fetch(e.api.runtime.getURL("_locales/"+t+"/messages.json")).then((e=>{e.json().then((e=>{Object.assign(i,e),n({langVars:i})}))})).catch((e=>{}))};a&&a!==t?r(a,null).then(i):i({langVars:{}})}}))},e.UpgradeHelper=function(t){this.loaded=!1,this.init=async()=>{e.api.runtime.onUpdateAvailable&&e.api.runtime.onUpdateAvailable.addListener((()=>{e.api.runtime.reload()})),this.loaded=!0},this.onInstalled=()=>{const n=t.helper.dao.getData("installationDate");(null===n||+new Date-n<6e4)&&(a("install"),t.helper.util.openLink({href:e.opts.website.youtube,newTab:!0})),t.reinitialize()},this.onUpdated=e=>{};const a=e=>new Promise((e=>{e()}))},e.UtilHelper=function(t){this.getParsedUrl=t=>t?(e.opts.urlAliases[e.browserName]&&e.opts.urlAliases[e.browserName][t]&&(t=e.opts.urlAliases[e.browserName][t]),t):t,this.openLink=a=>new Promise((n=>{let i="";a.params&&(i=Object.entries(a.params).map((([e,t])=>encodeURIComponent(e)+"="+t)).join("&"),i&&(i="?"+i));const s=this.getParsedUrl(a.href)+i;if(a.newTab&&!0===a.newTab){const i=(i=null)=>{e.api.tabs.query({active:!0,currentWindow:!0},(l=>{e.api.tabs.create({url:s,active:void 0===a.active||!!a.active,index:null===i?l[0].index+1:i,openerTabId:l[0].id},(e=>{t.helper.dao.setData("openedByExtension",e.id).then(n)}))}))};"afterLast"===a.position?e.api.tabs.query({currentWindow:!0},(e=>{let t=0;e.forEach((e=>{t=Math.max(t,e.index)})),i(t+1)})):"beforeFirst"===a.position?i(0):i()}else a.newWindow&&!0===a.newWindow?(e.api.windows.create({url:s,state:"maximized"}),n()):a.incognito&&!0===a.incognito?(e.api.windows.create({url:s,state:"maximized",incognito:!0}),n()):e.api.tabs.query({active:!0,currentWindow:!0},(a=>{e.api.tabs.update(a[0].id,{url:s},(e=>{t.helper.dao.setData("openedByExtension",e.id).then(n)}))}))}))};(new function(){this.reinitialize=(e={})=>{};const t=()=>{this.helper={dao:new e.DaoHelper(this),connect:new e.ConnectHelper(this),language:new e.LanguageHelper(this),upgrade:new e.UpgradeHelper(this),util:new e.UtilHelper(this)}},a=(t,n=0)=>{this.helper&&this.helper.upgrade&&this.helper.upgrade.loaded?"install"===t.reason?this.helper.upgrade.onInstalled():"update"===t.reason&&this.helper.upgrade.onUpdated(t):n<100&&e.delay(500).then((()=>{a(t,n+1)}))};this.run=()=>{const a=+new Date;"safari"===e.browserName?i():n(),t(),this.helper.connect.init().then((()=>Promise.all([this.helper.dao.init(),this.helper.language.init()]))).then((()=>Promise.all([this.helper.upgrade.init()]))).then((()=>this.reinitialize())).then((()=>{this.log("Finished bg script loading ",+new Date-a)}))};const n=()=>{e.api.runtime.onInstalled.addListener((e=>{a(e)}));let t=e.opts.website.extensionUrl.chrome;"Edge"===e.browserName&&(t=e.opts.website.extensionUrl.edge),e.api.runtime.setUninstallURL(t);const n=e.api.action||e.api.browserAction;n.onClicked.addListener((t=>{t.url.includes("youtube.com")?(n.setPopup({popup:"/media/html/popup.html?popup"}),n.openPopup(),n.setPopup({popup:""})):this.helper.util.openLink({href:e.opts.website.youtube,newTab:!0})}))},i=()=>{};this.log=t=>{e.isDev}}).run()})(jsu);